# Сервис Индексации (`AngularIndexer`)

`AngularIndexer` — это центральный и наиболее сложный сервис в расширении. Его основная задача — находить все Angular-элементы (компоненты, директивы, пайпы) в проекте, анализировать их и создавать эффективный индекс для быстрого поиска.

## Архитектура и Структуры Данных

Для каждого Angular-проекта в рабочем пространстве создается свой отдельный экземпляр `AngularIndexer`.

1.  **`Project` (из `ts-morph`)**: Каждый `AngularIndexer` управляет собственным экземпляром проекта `ts-morph`. Эта библиотека используется для парсинга TypeScript-кода и построения Абстрактного Синтаксического Дерева (AST). Это позволяет надежно извлекать метаданные из декораторов (`@Component`, `@Directive`).
2.  **`SelectorTrie`**: Это **префиксное дерево**, оптимизированное для быстрого поиска строк по их началу. Вместо того чтобы хранить селекторы как целые строки, дерево хранит их посимвольно.
    -   **Почему это важно?** Это позволяет мгновенно реализовывать автодополнение. Когда пользователь печатает `<my-comp...`, `SelectorTrie` может очень быстро найти все селекторы, начинающиеся с этого префикса.
3.  **`fileCache`**: Это `Map`, который кэширует результаты парсинга для каждого файла. Ключом является путь к файлу, а значением — информация о найденных в нем элементах и хэш содержимого файла. Это предотвращает повторный анализ файлов, которые не изменились, что критически важно для производительности.

## Жизненный цикл

1.  **Инициализация**:
    -   При старте расширения `AngularIndexer` пытается загрузить ранее сохраненный индекс из `workspaceState` (внутреннее хранилище VS Code). Это обеспечивает быстрый запуск без необходимости полного сканирования.
2.  **Полное сканирование (`generateFullIndex`)**:
    -   Если кэш пуст, запускается полное сканирование. Сервис использует `vscode.workspace.findFiles` для поиска всех файлов, соответствующих шаблонам (`*.component.ts` и т.д.).
    -   Каждый найденный файл анализируется, и информация о нем добавляется в `fileCache` и `SelectorTrie`.
3.  **Анализ селекторов (`parseAngularSelector`)**:
    -   Это **ключевая функция**, которая делает расширение таким "умным". Она находится в `src/utils/angular.ts`.
    -   Она не просто сохраняет селектор как есть. Для сложного селектора типа `table[jupiter-table][bigRows]` она разбирает его на составные части:
        -   `table[jupiter-table][bigRows]` (полная строка)
        -   `table` (имя тега)
        -   `[jupiter-table]` (атрибут в скобках)
        -   `jupiter-table` (имя атрибута)
        -   `[bigRows]`
        -   `bigRows`
    -   **Все эти части добавляются в `SelectorTrie` как отдельные ключи**, но все они ссылаются на одну и ту же директиву. Именно поэтому поиск по `bigRows` успешно находит `JupiterBigRowsDirective`.
4.  **Наблюдение за изменениями (`initializeWatcher`)**:
    -   После первичной индексации запускается `FileSystemWatcher`.
    -   Он следит за файловой системой и при любом изменении, создании или удалении Angular-файла **инкрементально** обновляет индекс, пере-анализируя только один измененный файл. Это делает расширение очень отзывчивым.

## Взаимодействие

-   `QuickfixProvider` и `CompletionProvider` обращаются к `AngularIndexer` для получения информации об элементах.
-   `getElement(selector)`: Находит элемент по **точному** совпадению ключа в `SelectorTrie`.
-   `searchWithSelectors(prefix)`: Использует мощь префиксного дерева для поиска всех селекторов, начинающихся с заданной строки. 